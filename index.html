<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>RPG Quest</title>

    <link rel="stylesheet" href="style.css?v=20260221d" />
    <link rel="stylesheet" href="grimoire.css?v=20260221c" />
  </head>

  <body>
    <div id="authOverlay" class="characterSetupOverlay hidden">
      <div class="characterSetupCard authCard">
        <div class="setupBrand">üîê Conta do player</div>
        <h1>Entrar ou criar conta</h1>
        <p class="setupLead">Use seu e-mail para salvar o personagem e continuar de onde parou.</p>

        <div class="authTabs">
          <button id="authLoginTab" type="button" class="authTab active">Login</button>
          <button id="authRegisterTab" type="button" class="authTab">Criar conta</button>
        </div>

        <div class="setupField">
          <label for="authEmail">E-mail</label>
          <input id="authEmail" type="email" placeholder="voce@email.com" autocomplete="email" />
        </div>
        <div class="setupField">
          <label for="authPassword">Senha</label>
          <input id="authPassword" type="password" placeholder="M√≠nimo 6 caracteres" autocomplete="current-password" />
        </div>
        <button id="authSubmitBtn" type="button">Entrar</button>
        <p id="authMessage" class="authMessage"></p>
      </div>
    </div>

    <div id="characterSetup" class="characterSetupOverlay hidden">
      <div class="characterSetupCard">
        <div class="setupBrand">‚öîÔ∏è Saramaz Quest</div>
        <h1>Crie seu personagem</h1>
        <p class="setupLead">Escolha um estilo para come√ßar a aventura.</p>

        <div class="setupField">
          <label for="setupName">Nome do personagem</label>
          <input id="setupName" maxlength="24" placeholder="Ex: Aria Storm" />
        </div>

        <div class="setupGrid">
          <div class="setupField">
            <label>Ra√ßa</label>
            <div id="setupRaceOptions" class="setupChoiceGroup"></div>
          </div>
          <div class="setupField">
            <label>Classe</label>
            <div id="setupClassOptions" class="setupChoiceGroup"></div>
          </div>
        </div>

        <div class="setupField">
          <label>Personagem base</label>
          <div id="setupCharacterOptions" class="setupCharacterOptions"></div>
        </div>

        <div class="setupField">
          <label>√çcone do personagem</label>
          <div id="setupAvatarOptions" class="setupAvatarOptions"></div>
        </div>

        <div class="setupField setupSpriteField">
          <label class="setupCheckboxLabel">
            <input id="setupUseSprite" type="checkbox" />
            Ver tokens de personagem (usar arte no token)
          </label>
        </div>

        <button id="setupStartBtn" type="button">Iniciar jornada</button>
      </div>
    </div>

    <div id="game">
      <div id="arenaWrap">
        <div id="arena"></div>
        <div id="combatSpellSlots" aria-label="Slots de magia r√°pidos"></div>
        <button
          id="diceTrayToggle"
          type="button"
          title="Abrir dados"
          aria-controls="diceTray"
          aria-expanded="false"
          onclick="toggleDiceTray()"
        >
          üé≤ Dados
        </button>
        <button
          id="grimoireQuickToggle"
          type="button"
          title="Abrir meu grim√≥rio"
          onclick="openMyGrimoire()"
        >
          üìñ Grim√≥rio
        </button>
        <div id="diceTray" class="collapsed" aria-hidden="true">
          <div class="diceTopRow">
            <div class="diceHeader">üé≤ Rolagem r√°pida</div>
            <button class="diceCloseBtn" type="button" onclick="closeDiceTray()" title="Fechar janela de dados">
              ‚úï
            </button>
          </div>
          <div id="diceResult">Use tamb√©m no chat: <code>/roll 2d6 + 1d4</code> (ou <code>/r</code>).</div>
          <div class="diceControls">
            <div class="dieControl">
              <button class="dieBtn dieIconBtn" onclick="rollDiceFromTray(4)" title="Rolar d4">
                <span class="dieGlyph">‚ñ≥</span>
                <span class="dieType">d4</span>
              </button>
              <input id="diceCount4" type="number" min="1" max="20" value="1" />
            </div>
            <div class="dieControl">
              <button class="dieBtn dieIconBtn" onclick="rollDiceFromTray(6)" title="Rolar d6">
                <span class="dieGlyph">‚ñ†</span>
                <span class="dieType">d6</span>
              </button>
              <input id="diceCount6" type="number" min="1" max="20" value="1" />
            </div>
            <div class="dieControl">
              <button class="dieBtn dieIconBtn" onclick="rollDiceFromTray(8)" title="Rolar d8">
                <span class="dieGlyph">‚óÜ</span>
                <span class="dieType">d8</span>
              </button>
              <input id="diceCount8" type="number" min="1" max="20" value="1" />
            </div>
            <div class="dieControl">
              <button class="dieBtn dieIconBtn" onclick="rollDiceFromTray(10)" title="Rolar d10">
                <span class="dieGlyph">‚¨ü</span>
                <span class="dieType">d10</span>
              </button>
              <input id="diceCount10" type="number" min="1" max="20" value="1" />
            </div>
            <div class="dieControl">
              <button class="dieBtn dieIconBtn" onclick="rollDiceFromTray(12)" title="Rolar d12">
                <span class="dieGlyph">‚¨¢</span>
                <span class="dieType">d12</span>
              </button>
              <input id="diceCount12" type="number" min="1" max="20" value="1" />
            </div>
            <div class="dieControl">
              <button class="dieBtn dieIconBtn" onclick="rollDiceFromTray(20)" title="Rolar d20">
                <span class="dieGlyph">‚ú∂</span>
                <span class="dieType">d20</span>
              </button>
              <input id="diceCount20" type="number" min="1" max="20" value="1" />
            </div>
            <div class="dieControl">
              <button class="dieBtn dieIconBtn" onclick="rollDiceFromTray(100)" title="Rolar d100">
                <span class="dieGlyph">‚óâ</span>
                <span class="dieType">d100</span>
              </button>
              <input id="diceCount100" type="number" min="1" max="20" value="1" />
            </div>
          </div>
        </div>
      </div>

      <div id="sidebar">
        <div class="topRow">
          <h2 id="partyTitle">Grupo</h2>
          <div class="pills">
            <div class="pill" title="Seu nome">
              üë§ <strong id="meName">-</strong>
            </div>
            <button id="logoutBtn" class="toggleBtn" type="button">üö™ Sair</button>
            <button
              id="masterToggle"
              class="toggleBtn"
              onclick="toggleMasterMode()"
            >
              üõ†Ô∏è Mestre: OFF
            </button>
          </div>
        </div>

        <div id="scenePanel">
          <div style="font-weight: 900; margin-bottom: 8px">Cena</div>

          <div class="sceneActions">
            <button class="toolBtn" type="button" onclick="exportChatReportPDF()">
              üßæ Gerar relat√≥rio da sess√£o (PDF)
            </button>
          </div>

          <div class="sceneGrid">
            <div class="field full">
              <label>Background (URL) ‚Äî cole um link direto de imagem</label>
              <input id="bgUrl" placeholder="Ex: https://.../mapa.png" />
            </div>

            <div class="field full">
              <label>Ou carregue um arquivo (local)</label>
              <input id="bgFile" type="file" accept="image/*" />
              <div class="sceneHint">
                Dica: arquivo local funciona s√≥ no seu PC; se quiser que
                ‚Äúmultiplayer‚Äù veja igual, use URL.
              </div>
            </div>

            <div class="field">
              <label>Zoom (Scale)</label>
              <input id="bgScale" type="range" min="40" max="300" value="120" />
            </div>
            <div class="field">
              <label>Opacidade</label>
              <input id="bgOpacity" type="range" min="0" max="100" value="65" />
            </div>

            <div class="field">
              <label>Offset X</label>
              <input id="bgX" type="range" min="-600" max="600" value="0" />
            </div>
            <div class="field">
              <label>Offset Y</label>
              <input id="bgY" type="range" min="-600" max="600" value="0" />
            </div>

            <div class="field full">
              <label>Ferramenta de Tiles (pintar m√≥dulos)</label>
              <div class="toolRow">
                <button
                  class="toolBtn active"
                  id="toolFloor"
                  onclick="setTool('floor')"
                >
                  üü¶ Ch√£o
                </button>
                <button class="toolBtn" id="toolWall" onclick="setTool('wall')">
                  üß± Parede
                </button>
                <button class="toolBtn" id="toolVoid" onclick="setTool('void')">
                  ‚¨õ Vazio
                </button>
                <button class="toolBtn" onclick="fillAll('floor')">
                  Preencher: Ch√£o
                </button>
                <button class="toolBtn" onclick="fillAll('wall')">
                  Preencher: Parede
                </button>
                <button class="toolBtn" onclick="fillAll('void')">
                  Preencher: Vazio
                </button>
                <button class="toolBtn" onclick="clearScene()">
                  Limpar Cena
                </button>
              </div>

              <div class="sceneHint" style="margin-top: 8px">
                Pintura r√°pida: clique e arraste.<br />
                Atalhos: <kbd>Shift</kbd> pinta Parede, <kbd>Alt</kbd> pinta
                Vazio, sem tecla pinta Ch√£o.
              </div>
            </div>
          </div>

          <hr class="sep" />

          <div class="sceneHint">
            Movimento: setas do teclado. Agora o token
            <strong>n√£o entra</strong> em Parede/Vazio.
          </div>
        </div>

        <div id="party"></div>

        <div id="chat"></div>

        <div id="replyPreview" class="hidden"></div>

        <div id="chatInput">
          <input
            id="messageInput"
            placeholder="Digite mensagem... (Enter envia)"
          />
          <button id="emojiBtn" type="button" onclick="toggleEmojiPicker()">üòÄ</button>
          <div id="emojiPicker" class="hidden"></div>
          <button onclick="sendMessage()">Enviar</button>
        </div>

        <div id="chatIdentityRow">
          <select id="chatSenderSelect"></select>
          <div id="chatProfileCreateRow">
            <input id="chatProfileName" placeholder="Novo perfil (ex: Narrador)" />
            <button type="button" onclick="addChatProfile()">Criar perfil</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Ficha -->
    <div id="sheetOverlay" class="modalOverlay">
      <div class="modal">
        <div class="modalHeader">
          <div>
            <h3 id="sheetTitle" class="modalTitle">Ficha</h3>
            <div id="sheetSub" class="modalSub"></div>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn" onclick="openGrimoire(sheetTargetName)">üìñ Abrir Grim√≥rio</button>
            <button class="btn" onclick="closeSheet()">Fechar</button>
          </div>
        </div>

        <div class="sheetColumns">
          <div class="panel">
            <div class="field">
              <label>Controlador (jogador)</label>
              <input id="sheetOwner" placeholder="Ex: Helton" />
            </div>
            <div class="field">
              <label>N√≠vel</label>
              <input id="sheetLevel" type="number" min="1" max="20" step="1" />
            </div>
            <div class="field">
              <label>Ra√ßa</label>
              <select id="sheetRace"></select>
            </div>
            <div class="field">
              <label>Classe</label>
              <select id="sheetClass"></select>
            </div>
            <div class="field">
              <label>Background</label>
              <select id="sheetBackground"></select>
            </div>

            <div style="font-weight: 900; margin: 10px 0 8px">
              Equipados (vem do Invent√°rio)
            </div>
            <div id="equipSlots"></div>
            <div style="opacity: 0.7; font-size: 12px; margin-top: 8px">
              Para comprar/trocar/usar itens: abra o üéí Invent√°rio.
            </div>
          </div>

          <div class="panel">
            <div style="font-weight: 900; margin-bottom: 8px">Atributos (mod)</div>
            <div class="statGrid">
              <div class="kv"><span>FOR</span><strong id="statSTR">-</strong></div>
              <div class="kv"><span>DES</span><strong id="statDEX">-</strong></div>
              <div class="kv"><span>CON</span><strong id="statCON">-</strong></div>
              <div class="kv"><span>INT</span><strong id="statINT">-</strong></div>
              <div class="kv"><span>SAB</span><strong id="statWIS">-</strong></div>
              <div class="kv"><span>CAR</span><strong id="statCHA">-</strong></div>
              <div class="kv"><span>Prof.</span><strong id="statProf">-</strong></div>
              <div class="kv"><span>Defesa</span><strong id="statDEF">-</strong></div>
              <div class="kv"><span>HP M√°x</span><strong id="statHPMax">-</strong></div>
              <div class="kv"><span>MP M√°x</span><strong id="statMPMax">-</strong></div>
              <div class="kv"><span>HP Atual</span><strong id="statHPNow">-</strong></div>
              <div class="kv"><span>MP Atual</span><strong id="statMPNow">-</strong></div>
            </div>

            <div style="font-weight: 900; margin: 10px 0 8px">Point Buy <span id="pointBuyUsed">0/27</span></div>
            <div id="sheetPointBuy" class="pointBuyGrid"></div>

            <div
              style="
                margin-top: 12px;
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
              "
            >
              <button
                class="smallBtn"
                onclick="editStat(sheetTargetName, 'hp')"
              >
                ‚ù§Ô∏è HP (+/-)
              </button>
              <button
                class="smallBtn"
                onclick="editStat(sheetTargetName, 'mana')"
              >
                üîµ MP (+/-)
              </button>
              <button
                class="smallBtn smallBtnPrimary"
                onclick="openInventory(sheetTargetName)"
              >
                üéí Invent√°rio
              </button>
              <button
                class="smallBtn smallBtnPrimary"
                onclick="openGrimoire(sheetTargetName)"
              >
                üìñ Grim√≥rio
              </button>
            </div>
          </div>

          <div class="panel">
            <div style="font-weight: 900; margin-bottom: 8px">Per√≠cias</div>
            <div id="sheetSkills" class="skillsList"></div>
            <div style="font-weight: 900; margin: 12px 0 8px">Habilidades (clic√°veis)</div>
            <div id="sheetAbilities" class="abilities"></div>
          </div>
        </div>

        <div class="sheetActions">
          <button class="btn" onclick="closeSheet()">Cancelar</button>
          <button class="btn btnPrimary" onclick="saveSheet()">Salvar</button>
        </div>
      </div>
    </div>

    <!-- Modal Grim√≥rio -->
    <div id="grimoireOverlay" class="modalOverlay">
      <div class="modal">
        <div class="modalHeader">
          <div>
            <h3 id="grimoireTitle" class="modalTitle">Grim√≥rio</h3>
            <div id="grimoireSub" class="modalSub"></div>
          </div>
          <button class="btn" onclick="closeGrimoire()">Fechar</button>
        </div>

        <div class="grimoireColumns">
          <div class="grimoireTabs" role="tablist" aria-label="Navega√ß√£o do grim√≥rio">
            <button class="grimoireTab active" data-tab="resources" type="button" role="tab" aria-selected="true" onclick="setGrimoireTab('resources')">üìö Recursos</button>
            <button class="grimoireTab" data-tab="create" type="button" role="tab" aria-selected="false" onclick="setGrimoireTab('create')">‚úçÔ∏è Criar magia</button>
            <button class="grimoireTab" data-tab="spells" type="button" role="tab" aria-selected="false" onclick="setGrimoireTab('spells')">‚ú® Minhas magias</button>
          </div>

          <div class="panel grimoirePanel" data-tab="resources">
            <div style="font-weight:900; margin-bottom:8px;">Recursos do conjurador</div>
            <div id="grimoireMeta" class="kvList"></div>
            <div style="font-weight:900; margin:14px 0 8px;">Slots de magia</div>
            <div id="grimoireSlots"></div>
            <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
              <button class="smallBtn" onclick="resetSpellSlots(grimoireTargetName)">üåô Resetar slots (descanso longo)</button>
            </div>
          </div>

          <div class="panel grimoirePanel" data-tab="create">
            <div style="font-weight:900; margin-bottom:8px;">Criar magia customizada</div>
            <div class="field"><label>Nome</label><input id="spellName" placeholder="Ex: Explos√£o Flamejante" /></div>
            <div class="field"><label>N√≠vel da magia</label><input id="spellLevel" type="number" min="1" max="9" value="1" /></div>
            <div class="field">
              <label>√çcone da magia</label>
              <div id="spellIconLibrary" class="iconLibrary"></div>
            </div>
            <div class="field"><label>Tempo de conjura√ß√£o</label><input id="spellCastingTime" placeholder="Ex: 1 a√ß√£o" value="1 a√ß√£o" /></div>
            <div class="field"><label>Alcance</label><input id="spellRange" placeholder="Ex: 18m" value="18m" /></div>
            <div class="field"><label>Descri√ß√£o</label><textarea id="spellDescription" rows="3" placeholder="Resumo da magia"></textarea></div>

            <div class="field">
              <label>Componentes</label>
              <div class="chipRow">
                <label><input type="checkbox" id="compV" checked /> V</label>
                <label><input type="checkbox" id="compS" checked /> S</label>
                <label><input type="checkbox" id="compM" /> M</label>
              </div>
            </div>

            <div style="font-weight:900; margin:12px 0 8px;">Efeitos (cards)</div>
            <div id="spellEffectsCatalog" class="effectsCatalog"></div>
            <div id="spellCostSummary" class="spellCostSummary"></div>
            <button class="btn btnPrimary" onclick="createCustomSpell()">Salvar magia</button>
          </div>

          <div class="panel grimoirePanel" data-tab="spells">
            <div style="font-weight:900; margin-bottom:8px;">Magias customizadas</div>
            <div id="customSpellsList"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Invent√°rio + Loja -->
    <div id="invOverlay" class="modalOverlay">
      <div class="modal">
        <div class="modalHeader">
          <div>
            <h3 id="invTitle" class="modalTitle">Invent√°rio</h3>
            <div id="invSub" class="modalSub"></div>
          </div>
          <button class="btn" onclick="closeInventory()">Fechar</button>
        </div>

        <div class="invColumns">
          <div class="panel">
            <div class="invHeaderRow">
              <div class="goldPill">
                <span>ü™ô</span>
                <span>Ouro:</span>
                <strong id="goldValue">0</strong>
                <span style="opacity: 0.7">|</span>
                <span style="opacity: 0.85">Slots:</span>
                <strong id="invSlotsValue">0/0</strong>
              </div>
              <button
                class="smallBtn smallBtnPrimary"
                onclick="openSheet(invTargetName)"
              >
                üìú Voltar pra Ficha
              </button>
            </div>

            <div style="font-weight: 900; margin-bottom: 8px">
              Itens no Invent√°rio
            </div>
            <div id="invList" class="invList"></div>
          </div>

          <div class="panel">
            <div class="invHeaderRow">
              <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap">
                <div style="font-weight: 900">Lojas</div>
                <div id="shopTabs" class="shopTabs"></div>
              </div>
              <div id="arsenalSubTabs" class="shopTabs"></div>
            </div>

            <div id="shopList" class="shopList"></div>
            <div id="smithApplyBox" class="smithApplyBox" style="display:none"></div>

            <div style="opacity: 0.7; font-size: 12px; margin-top: 10px">
              Itens equip√°veis v√£o pra ficha quando equipados.
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="app.js?v=20260221b"></script>
  </body>
</html>
